name: build check
on:
  pull_request:

permissions:
  actions: read
  attestations: read
  checks: read
  contents: read
  deployments: read
  discussions: read
  id-token: write
  issues: read
  packages: read
  pages: read
  pull-requests: read
  repository-projects: read
  security-events: read
  statuses: read

jobs:
  pre-workflow:
    uses: ./.github/workflows/agent-of-me.yml
    with:
      pr-number: ${{ github.event.pull_request.number }}
      triggered-name: "build check"
    secrets:
      AGENT_OF_ME_APP_ID: ${{ secrets.AGENT_OF_ME_APP_ID }}
      AGENT_OF_ME_PRIVATE_KEY: ${{ secrets.AGENT_OF_ME_PRIVATE_KEY }}

  pre-build:
    runs-on: ubuntu-latest
    outputs:
      check: ${{ steps.change.outputs.nix }}
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/flake-checker-action@main
      - uses: dorny/paths-filter@v3
        id: change
        with:
          filters: |
            nix:
              - "**.nix"
              - "flake.lock"

  build-check-matrix:
    needs: [pre-build]
    if: needs.pre-build.outputs.check == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-24.04", "ubuntu-24.04-arm", "macos-26"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: wimpysworld/nothing-but-nix@main
        if: runner.os == 'Linux'
        with:
          hatchet-protocol: "rampage" # Options: holster, carve, cleave (default), rampage
          root-safe-haven: "8192"

      - uses: actions/checkout@v6

      - uses: DeterminateSystems/nix-installer-action@v21
        with:
          extra-conf: |
            accept-flake-config = true
            connect-timeout = 15
            cores = 2
            http-connections = 25
            max-jobs = 2
            stalled-download-timeout = 15

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v16
        with:
          name: misumisumi
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: true

      - name: Remove unused packages of macos
        if: runner.os == 'macOS'
        run: |
          df -h
          # shellcheck disable=SC2046
          brew uninstall --force $(brew list)
          brew cleanup

          sudo rm -rf /Applications/Xcode.app
          sudo xcode-select --reset
          sudo rm -rf /Library/Developer/CommandLineTools
          sudo rm -rf ~/Library/Developer/Xcode
          df -h

      - name: Build check
        uses: gacts/run-and-post-run@v1
        with:
          run: nix run github:Mic92/nix-fast-build  -- --no-link --no-nom --result-file result.json
          post: jq -r '.results[] | select(.success==false) | .attr' result.json

  build-check-summary:
    runs-on: ubuntu-latest
    needs: [pre-build, build-check-matrix]
    if: ${{ !cancelled() }}
    steps:
      - name: build-check-skipped
        if: ${{ needs.pre-build.outputs.check == 'false' && needs.build-check-matrix.result == 'skipped' }}
        run: |
          exit 0
      - name: build-check-success
        if: ${{ needs.pre-build.outputs.check == 'true' && needs.build-check-matrix.result == 'success' }}
        run: |
          exit 0
      - name: build-check-failed
        if: ${{ needs.pre-build.outputs.check == 'true' && needs.build-check-matrix.result != 'success' }}
        run: |
          exit 1

  post-workflow:
    uses: ./.github/workflows/agent-of-me.yml
    needs: [pre-workflow, build-check-summary]
    if: ${{ !cancelled() }}
    with:
      pr-number: ${{ github.event.pull_request.number }}
      triggered-name: "build-check"
    secrets:
      AGENT_OF_ME_APP_ID: ${{ secrets.AGENT_OF_ME_APP_ID }}
      AGENT_OF_ME_PRIVATE_KEY: ${{ secrets.AGENT_OF_ME_PRIVATE_KEY }}
